<!DOCTYPE html>
<html>
    <head>
        <meta charset="UTF-8">
        <title>Tetrif</title>
        <link rel="stylesheet" href="style.css">
        <script src="https://cdn.jsdelivr.net/npm/vue@2.5.17/dist/vue.js"></script>
    </head>
    <body>
        <div id="app">
            <div class="display">
                <div class="hold">
                    <p class="box_title">HOLD</p>
                    <div class="minoBox">
                        <table class="minoBox_table">
                            <tr v-for="line in hold">
                                <td v-for="block in line">
                                    <div :class="defMinoBlockClass(block)"></div>
                                </td>
                            </tr>
                        </table>
                    </div>
                </div>
                <table>
                    <tr v-for="line in 21" :id="lineId(line)">
                        <td v-for="block in 10">
                            <div :id="blockId(line, block)" :class="defClass(line, block)"></div>
                        </td>
                    </tr>
                </table>
                <div class="next">
                    <p class="box_title">NEXT</p>
                    <div :class="defMinoBoxClass(index)" v-for="(mino, index) in next">
                        <table class="minoBox_table">
                            <tr v-for="line in mino">
                                <td v-for="block in line">
                                    <div :class="defMinoBlockClass(block)"></div>
                                </td>
                            </tr>
                        </table>
                    </div>
                </div>
            </div>
            <button @click="startGame">スタート</button>
            <button @click="gumsiro">ガムシロ積み</button>
            <span>score : {{totalScore}}</span>
            <span v-if="BtoB">Back to Back</span>
            <!-- <button v-on:click="addMino(1)">Iミノ</button>
            <button v-on:click="addMino(2)">Oミノ</button>
            <button v-on:click="addMino(3)">Zミノ</button>
            <button v-on:click="addMino(4)">Sミノ</button>
            <button v-on:click="addMino(5)">Lミノ</button>
            <button v-on:click="addMino(6)">Jミノ</button>
            <button v-on:click="addMino(7)">Tミノ</button> -->
        </div>
        <script>
            var vueClass = new Vue({
                el:"#app",
                data: {
                    display: [
                        [19, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 19],
                        [19, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 19],
                        [19, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 19],
                        [19, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 19],
                        [19, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 19],
                        [19, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 19],
                        [19, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 19],
                        [19, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 19],
                        [19, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 19],
                        [19, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 19],
                        [19, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 19],
                        [19, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 19],
                        [19, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 19],
                        [19, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 19],
                        [19, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 19],
                        [19, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 19],
                        [19, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 19],
                        [19, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 19],
                        [19, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 19],
                        [19, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 19],
                        [19, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 19],
                        [19, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 19],
                        [19, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 19],
                        [19, 19, 19, 19, 19, 19, 19, 19, 19, 19, 19, 19],
                    ],
                    hold: [],
                    holdNum: 0,
                    holdCount: 0,
                    next: [],
                    nextMino:[],
                    kindOfMino: [1, 2, 3, 4, 5, 6, 7],
                    controlMino: [
                        [
                            [0, 0],
                            [0, 0],
                            [0, 0],
                            [0, 0]
                        ],
                        ["", 0, 0]
                    ],
                    fellMino: [],
                    fallSpeed: 1000,
                    moveCount: 0,
                    intervalId: "",
                    SUintervalId: "",
                    timeoutId: [],
                    spin1Val:[[-1, 1], [1, 1], [1, -1], [-1, -1]],
                    spin2Val:[[0, 2], [2, 0], [0, -2], [-2, 0]],
                    spin3Val:[[0, 1], [1, 0], [0, -1], [-1, 0]],
                    spin4Val:[[-1, 2], [2, 1], [1, -2], [-2, -1]],
                    spin5Val:[[2, -1], [-1, -2], [-2, 1], [1, 2]],
                    BtoB: false,
                    ren: 0,
                    totalScore: 0
                },
                methods: {
                    lineId: function(line) {
                        return "line" + line;
                    },
                    blockId: function(line, block) {
                        return "block" + line + "-" + block;
                    },
                    defClass: function(line, block) {
                        if (this.display[line + 1][block] >= 10) {
                            return "color" + (this.display[line + 1][block] % 10);
                        } else {
                            return "fell" + (this.display[line + 1][block] % 10);
                        }
                    },
                    defMinoBlockClass: function(block) {
                        return "minoBox_color" + block;
                    },
                    defMinoBoxClass: function(index) {
                        return index == 0 ? "minoBox" : "minoBox_child";
                    },
                    defMinoBoxArray: function(minoNum) {
                        var array = [];
                        switch (minoNum) {
                            case 1:
                                array.push([1, 1, 1, 1]);
                                break;
                            case 2:
                                array.push([2, 2]);
                                array.push([2, 2]);
                                break;
                            case 3:
                                array.push([3, 3, 0]);
                                array.push([0, 3, 3]);
                                break;
                            case 4:
                                array.push([0, 4, 4]);
                                array.push([4, 4, 0]);
                                break;
                            case 5:
                                array.push([0, 0, 5]);
                                array.push([5, 5, 5]);
                                break;
                            case 6:
                                array.push([6, 0, 0]);
                                array.push([6, 6, 6]);
                                break;
                            case 7:
                                array.push([0, 7, 0]);
                                array.push([7, 7, 7]);
                                break;
                            default:
                                console.log("error at defMinoBoxArray()");
                                break;
                        }
                        return array;
                    },
                    startGame: function() {
                        this.prepareMino();
                        this.addMino(this.nextMino.splice(0, 1)[0]);
                        for (var i = 0; i < 4; i++) {
                            this.next.push(this.defMinoBoxArray(this.nextMino[i]))
                        }
                        this.SUintervalId = setInterval(this.fallSpeedUp, 1000);
                    },
                    gumsiro: function() {
                        this.display = [
                            [19, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 19],
                            [19, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 19],
                            [19, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 19],
                            [19, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 19],
                            [19, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 19],
                            [19, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 19],
                            [19, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 19],
                            [19, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 19],
                            [19, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 19],
                            [19, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 19],
                            [19, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 19],
                            [19, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 19],
                            [19, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 19],
                            [19, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 19],
                            [19, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 19],
                            [19, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 19],
                            [19, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 19],
                            [19, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 19],
                            [19, 21, 0, 0, 0, 0, 0, 0, 0, 22, 22, 19],
                            [19, 21, 0, 0, 0, 0, 0, 0, 0, 22, 22, 19],
                            [19, 21, 26, 26, 0, 0, 0, 0, 0, 25, 25, 19],
                            [19, 21, 26, 0, 0, 0, 0, 24, 24, 25, 25, 19],
                            [19, 26, 26, 26, 0, 23, 23, 27, 21, 25, 25, 19],
                            [19, 19, 19, 19, 19, 19, 19, 19, 19, 19, 19, 19],
                        ];
                        this.startGame();
                        this.holdMino();
                    },
                    fallSpeedUp: function() {
                        if (this.fallSpeed > 500) {
                            this.fallSpeed--;
                        }
                    },
                    prepareMino: function() {
                        for (var i = 0; i < 7; i++) {
                            this.nextMino.push(this.kindOfMino.splice(Math.floor(Math.random() * this.kindOfMino.length), 1)[0]);
                        }
                        this.kindOfMino = [1, 2, 3, 4, 5, 6, 7];
                    },
                    nextTurn: function() {
                        if (this.nextMino.length < 7) {
                            this.prepareMino();
                        }
                        this.next.splice(0, 1);
                        this.next.push(this.defMinoBoxArray(this.nextMino[4]));
                        this.addMino(this.nextMino.splice(0, 1)[0]);
                    },
                    addMino: function(minoNum) {
                        var array = [];
                        var judge = true;
                        switch (minoNum) {
                            case 1:
                                array = [[3, 4], [3, 5], [3, 6], [3, 7]];
                                this.controlMino[1] = ["I", 0, 1];
                                break;
                            case 2:
                                array = [[2, 5], [2, 6], [3, 5], [3, 6]];
                                this.controlMino[1] = ["O", 0, 2];
                                break;
                            case 3:
                                array = [[3, 5], [3, 6], [2, 5], [2, 4]];
                                this.controlMino[1] = ["Z", 0, 3];
                                break;
                            case 4:
                                array = [[3, 5], [3, 4], [2, 5], [2, 6]];
                                this.controlMino[1] = ["S", 0, 4];
                                break;
                            case 5:
                                array = [[3, 5], [3, 4], [3, 6], [2, 6]];
                                this.controlMino[1] = ["L", 0, 5];
                                break;
                            case 6:
                                array = [[3, 5], [3, 6], [3, 4], [2, 4]];
                                this.controlMino[1] = ["J", 0, 6];
                                break;
                            case 7:
                                array = [[3, 5], [3, 4], [2, 5], [3, 6]];
                                this.controlMino[1] = ["T", 0, 7];
                                break;
                            default:
                                console.log("error at addMino()");
                                break;
                        }
                        for (var [i, j] of array) {
                            if (this.display[i][j] >= 19) {
                                judge = false;
                            }
                            this.display[i].splice(j, 1, this.controlMino[1][2] + 10);
                        }
                        if (judge) {
                            this.controlMino.splice(0, 1, array.slice());
                            this.culcFellMino();
                            this.intervalId = setInterval(this.fallMino, this.fallSpeed);
                        } else {
                            this.gameOver();
                        }
                    },
                    holdMino: function() {
                        if (this.intervalId && this.holdCount == 0) {
                            var num = 0;
                            clearInterval(this.intervalId);
                            this.intervalId = "";
                            for (var i of this.timeoutId) {
                                clearInterval(i);
                            }
                            this.timeoutId = [];
                            this.deleteColor();
                            this.moveCount = 0;
                            if (this.holdNum > 0) {
                                num = this.holdNum;
                            }
                            this.holdNum = this.controlMino[1][2];
                            this.hold = this.defMinoBoxArray(this.holdNum);
                            if (num > 0) {
                                this.addMino(num);
                                this.holdCount++;
                            } else {
                                this.nextTurn();
                            }
                        }
                    },
                    //ミノが1マス落ちるメソッド
                    fallMino: function() {
                        var judge = true;
                        var array = [];
                        var color = this.controlMino[1][2];
                        //1マス下に進めるならjudge = true、進めないならjudge = false
                        for (var [i, j] of this.controlMino[0]){
                            if (this.display[i + 1][j] >= 19) {
                                judge = false;
                            }
                        }
                        if (judge) {
                            this.deleteColor();
                            this.controlMino[0].forEach(([i, j], index) => {
                                this.controlMino[0][index].splice(0, 1, this.controlMino[0][index][0] + 1);
                            })
                            this.paintColor();
                        }
                        this.ground(0);
                    },
                    timeout: function() {
                        for (var [i, j] of this.controlMino[0]) {
                            this.display[i].splice(j, 1, this.display[i][j] + 20);
                        }
                        clearInterval(this.intervalId);
                        this.intervalId = "";
                        for (var i of this.timeoutId) {
                            clearInterval(i);
                        }
                        this.timeoutId = [];
                        this.clearLine();
                        this.moveCount = 0;
                        this.holdCount = 0;
                    },
                    moveX: function(val) {
                        if (this.timeoutId) {
                            for (var i of this.timeoutId) {
                                clearInterval(i);
                            }
                            this.timeoutId = [];
                        }
                        if (this.intervalId) {
                            var judge = true;
                            var color = this.controlMino[1][2];
                            for (var [i, j] of this.controlMino[0]) {
                                if (this.display[i][j + val] >= 19) {
                                    judge = false;
                                }
                            }
                            if (judge) {
                                this.deleteColor();
                                this.controlMino[0].forEach(([i, j], index) => {
                                    this.controlMino[0][index].splice(1, 1, this.controlMino[0][index][1] + val);
                                })
                                this.paintColor();
                            }
                        }
                        this.culcFellMino();
                        this.ground(1);
                    },
                    culcFellMino: function() {
                        var color = this.controlMino[1][2];
                        var min = 24;
                        var len;
                        if (this.fellMino) {
                            for (var [i, j] of this.fellMino) {
                                if (this.display[i][j] < 10) {
                                    this.display[i].splice(j, 1, 0);
                                }
                            }
                            this.fellMino = [];
                        }
                        for (var [i, j] of this.controlMino[0]) {
                            len = 0;
                            for (var k = i + 1; k < 24; k++) {
                                if (this.display[k][j] >= 19) {
                                    len = k - i - 1;
                                    break;
                                }
                            }
                            min = (len < min) ? len : min;
                        }
                        for (var i = 0; i < 4; i++) {
                            this.fellMino.push([this.controlMino[0][i][0] + min, this.controlMino[0][i][1]]);
                            if (this.display[this.controlMino[0][i][0] + min][this.controlMino[0][i][1]] < 10) {
                                this.display[this.controlMino[0][i][0] + min].splice(this.controlMino[0][i][1], 1, color);
                            }
                        }
                    },
                    culcRenPower: function(ren) {
                        if (ren <= 9) {
                            return Math.floor(ren / 2);
                        } else if (ren == 10) {
                            return 4;
                        } else {
                            return 5;
                        }
                    },
                    fallSkip: function() {
                        if (this.intervalId) {
                            clearInterval(this.intervalId);
                            this.intervalId = "";
                            for (var i of this.timeoutId) {
                                clearInterval(i);
                            }
                            this.timeoutId = [];
                            var color = this.controlMino[1][2];
                            var min = 24;
                            var len;
                            this.deleteColor();
                            for (var [i, j] of this.controlMino[0]) {
                                len = 0;
                                for (var k = i + 1; k < 24; k++) {
                                    if (this.display[k][j] >= 19) {
                                        len = k - i - 1;
                                        break;
                                    }
                                }
                                min = (len < min) ? len : min;
                            }
                            for (var i = 0; i < 4; i++) {
                                this.controlMino[0][i].splice(0, 1, this.controlMino[0][i][0] + min);
                                this.display[this.controlMino[0][i][0]].splice(this.controlMino[0][i][1], 1, color + 20);
                            }
                            this.moveCount = 0;
                            this.holdCount = 0;
                            this.clearLine();
                        }
                    },
                    spin: function(lotate, index, spinWay, spinNum) {
                        var spined = (((lotate + this.controlMino[1][1] + (spinWay > 0 ? 0 : -1)) % 4) + 4) % 4;
                        var nowMino = this.controlMino[0][index];
                        var spinVal;
                        switch (spinNum) {
                            case 1:
                                spinVal = this.spin1Val[spined];
                                break;
                            case 2:
                                spinVal = this.spin2Val[spined];
                                break;
                            case 3:
                                spinVal = this.spin3Val[spined];
                                break;
                            case 4:
                                spinVal = this.spin4Val[spined];
                                break;
                            case 5:
                                spinVal = this.spin5Val[spined];
                                break;
                        }
                        returnArray =  [nowMino[0] + spinVal[0] * spinWay, nowMino[1] + spinVal[1] * spinWay];
                        return [nowMino[0] + spinVal[0] * spinWay, nowMino[1] + spinVal[1] * spinWay];
                    },
                    Tspin: function(val) {
                        var spined = ((this.controlMino[1][1] % 4) + 4) % 4;
                        var tempCM = this.controlMino[0];
                        var moveToArray = [[], [], [], []];
                        var moveBottom = 0;
                        var judge = false;
                        switch (spined) {
                            case 0:
                                if (this.display[tempCM[2][0]][tempCM[2][1] - val] >= 19) {
                                    moveToArray[0] = [2, -val];
                                    moveToArray[2] = [3, 0];
                                    moveToArray[2 + val] = [3, -val * 2];
                                    moveToArray[2 - val] = [1, 0];
                                    judge = this.moveToSpace(tempCM, moveToArray, val);
                                } else {
                                    moveToArray[0] = [0, -val];
                                    moveToArray[2] = [1, 0];
                                    moveToArray[2 + val] = [1, -val * 2];
                                    moveToArray[2 - val] = [-1, 0];
                                    judge = this.moveToSpace(tempCM, moveToArray, val);
                                }
                                break;
                            case 1:
                            case 3:
                                if (this.display[tempCM[0][0]][tempCM[0][1] + (spined - 2)] >= 19) {
                                    if ((this.display[tempCM[2][0]][tempCM[2][1] - (spined - 2)] >= 19)) {
                                        moveBottom = 1;
                                    }
                                    moveToArray[0] = [moveBottom, -(spined - 2)];
                                    moveToArray[2] = [-val * (spined - 2) + moveBottom, 0];
                                    moveToArray[2 + val] = [val * (spined - 2) + moveBottom, 0];
                                    moveToArray[2 - val] = [-val * (spined - 2) + moveBottom, -(spined - 2) * 2];
                                    judge = this.moveToSpace(tempCM, moveToArray, val);
                                }
                                break;
                            case 2:
                                if (this.display[tempCM[0][0] - 1][tempCM[0][1]] >= 19) {
                                    moveToArray[0] = [2, 0];
                                    moveToArray[2] = [1, -val];
                                    moveToArray[2 + val] = [1, val];
                                    moveToArray[2 - val] = [3, -val];
                                    judge = this.moveToSpace(tempCM, moveToArray, val);
                                    if (!judge) {
                                        moveToArray[0] = [2, val];
                                        moveToArray[2] = [1, 0];
                                        moveToArray[2 + val] = [1, val * 2];
                                        moveToArray[2 - val] = [3, 0];
                                        judge = this.moveToSpace(tempCM, moveToArray, val);
                                    }
                                }
                                break;
                        }
                        return judge;
                    },
                    SZspin: function(val, whichMino) { //SならwhichMino = 0, ZならwhichMino = 1
                        var spined = ((this.controlMino[1][1] + 2 * whichMino % 4) + 4) % 4;
                        if (whichMino == 1) {
                            spined = (spined == 0 || spined == 2) ? (spined == 0 ? 2 : 0) : spined;
                        }
                        var tempCM = this.controlMino[0];
                        var judge = false;
                        switch (spined) {
                            case 0:
                                if (this.display[tempCM[0][0]][tempCM[0][1] - val] >= 19 || this.display[tempCM[0][0] - 1][tempCM[0][1] + val] >= 19 || this.display[tempCM[0][0] - 2][tempCM[0][1] + val] >= 19) {
                                    judge = this.moveToSpace(tempCM, [[2, 0], [3, -val], [3, val], [2, val * 2]], val);
                                }
                                if (this.display[tempCM[0][0] - 1][tempCM[0][1] + val] >= 19 && !judge) {
                                    judge = this.moveToSpace(tempCM, [[2, -val], [3, -val * 2], [3, 0], [2, val]], val);
                                }
                                break;
                            case 1:
                                if (this.display[tempCM[0][0] + 1][tempCM[0][1]] >= 19) {
                                    judge = this.moveToSpace(tempCM, [[1, val], [2, val * 2], [2, 0], [1,-val]], val);
                                }
                                break;
                            case 3:
                                if (this.display[tempCM[0][0]][tempCM[0][1] - val] >= 19 && this.display[tempCM[2][0]][tempCM[2][1] + val] >= 19) {
                                    judge = this.moveToSpace(tempCM, [[1, val], [0, 0], [2, 0], [3, val]], val);
                                }
                                break;
                        }
                        return judge;
                    },
                    LJspin: function(val, whichMino) { //LならwhichMino = 0, JならwhichMino = 1
                        var spined = ((this.controlMino[1][1] + 2 * whichMino % 4) + 4) % 4;
                        if (whichMino == 1) {
                            spined = (spined == 0 || spined == 2) ? (spined == 0 ? 2 : 0) : spined;
                        }
                        var tempCM = this.controlMino[0];
                        var judge = false;
                        switch (spined) {
                            case 0:
                                if (this.display[tempCM[1][0] - 1][tempCM[1][1]] >= 19 || this.display[tempCM[1][0] - 2][tempCM[1][1]] >= 19) {
                                    judge = this.moveToSpace(tempCM, [[2, -val], [1, 0], [3, -val * 2], [4, -val]], val);
                                    if (!judge) judge = this.moveToSpace(tempCM, [[2, 0], [1, val], [3, -val], [4, 0]], val);
                                }
                                break;
                            case 1:
                                var isBlock = 0;
                                if (this.display[tempCM[2][0]][tempCM[2][1] - val] >= 19) isBlock++;
                                if (this.display[tempCM[2][0] - 1][tempCM[2][1] + val] >= 19) isBlock++;
                                if (isBlock == 1) {
                                    judge = this.moveToSpace(tempCM, [[1, val], [2, val * 2], [0, 0], [1, -val]], val);
                                }
                                break;
                            case 3:
                                if ((this.display[tempCM[3][0] + 1][tempCM[3][1]] >= 19 || this.display[tempCM[3][0] + 1][tempCM[3][1] - val] >= 19) && (val + whichMino == 0 || val + whichMino == 1)) {
                                    judge = this.moveToSpace(tempCM, [[1, -val], [0, -val * 2], [2, 0], [1, val]], val);
                                } else if ((this.display[tempCM[3][0] + 1][tempCM[3][1]] >= 19 || this.display[tempCM[3][0] + 1][tempCM[3][1] - val * 2] >= 19) && (val + whichMino == -1 || val + whichMino == 2)) {
                                    judge = this.moveToSpace(tempCM, [[1, val], [0, 0], [2, val * 2], [3, val]], val);
                                }
                                break;
                        }
                        return judge;
                    },
                    Ispin: function(val) {
                        var spined = ((this.controlMino[1][1] % 4) + 4) % 4;
                        var tempCM = this.controlMino[0];
                        var judge = false;
                        switch (spined) {
                            case 0:
                                if (this.display[tempCM[0][0] - 1][tempCM[0][1]] >= 19 || this.display[tempCM[0][0] - 2][tempCM[0][1]] >= 19 || this.display[tempCM[0][0] - 3][tempCM[0][1]] >= 19) {
                                    if (val == -1 && this.display[tempCM[0][0] - 3][tempCM[0][1]] < 19) break;
                                    judge = this.moveToSpace(tempCM, [[-1, 2], [0, 1], [1, 0], [2, -1]], val);
                                    if (!judge) judge = this.moveToSpace(tempCM, [[-1, 3], [0, 2], [1, 1], [2, 0]], val);
                                    if (!judge) judge = this.moveToSpace(tempCM, [[0, 0], [1, -1], [2, -2], [3, -3]], val);
                                }
                                if (!judge && this.display[tempCM[3][0] - 3][tempCM[3][1]] >= 19) {
                                    judge = this.moveToSpace(tempCM, [[-2, 2], [-1, 1], [0, 0], [1, -1]], val);
                                    if (!judge) judge = this.moveToSpace(tempCM, [[-2, 0], [-1, -1], [0, -2], [1, -3]], val);
                                    if (!judge) judge = this.moveToSpace(tempCM, [[3, 3], [2, 2], [1, 1], [0, 0]], val);
                                }
                                break;
                            case 2:
                                if (this.display[tempCM[0][0] - 1][tempCM[0][1]] >= 19 || this.display[tempCM[0][0] - 2][tempCM[0][1]] >= 19 || this.display[tempCM[0][0] - 3][tempCM[0][1]] >= 19) {
                                    if (val == 1 && this.display[tempCM[0][0] - 3][tempCM[0][1]] < 19) break;
                                    judge = this.moveToSpace(tempCM, [[1, -1], [0, 0], [-1, 1], [-2, 2]], val);
                                    if (!judge) judge = this.moveToSpace(tempCM, [[1, -3], [0, -2], [-1, -1], [-2, 0]], val);
                                    if (!judge) judge = this.moveToSpace(tempCM, [[0, 0], [1, 1], [2, 2], [3, 3]], val);
                                }
                                if (!judge && this.display[tempCM[3][0] - 3][tempCM[3][1]] >= 19) {
                                    judge = this.moveToSpace(tempCM, [[1, -1], [0, 0], [-1, 1], [-2, 2]], val);
                                    if (!judge) judge = this.moveToSpace(tempCM, [[1, -3], [0, -2], [-1, -1], [-2, 0]], val);
                                    if (!judge) judge = this.moveToSpace(tempCM, [[0, 0], [1, 1], [2, 2], [3, 3]], val);
                                }
                                break;
                            case 1:
                                if (val == 1){
                                    judge = this.moveToSpace(tempCM, [[2, 0], [1, -1], [0, -2], [-1, -3]], val);
                                    if (!judge) judge = this.moveToSpace(tempCM, [[0, 0], [-1, -1], [-2, -2], [-3, -3]], val);
                                    if (!judge) judge = this.moveToSpace(tempCM, [[3, 3], [2, 2], [1, 1], [0, 0]], val);
                                } else {
                                    judge = this.moveToSpace(tempCM, [[2, 0], [1, 1], [0, 2], [-1, 3]], val);
                                }
                                break;
                            case 3:
                                if (val == -1){
                                    judge = this.moveToSpace(tempCM, [[-1, 3], [0, 2], [1, 1], [2, 0]], val);
                                    if (!judge) judge = this.moveToSpace(tempCM, [[-3, 3], [-2, 2], [-1, 1], [0, 0]], val);
                                    if (!judge) judge = this.moveToSpace(tempCM, [[0, 0], [1, -1], [2, -2], [3, -3]], val);
                                } else {
                                    judge = this.moveToSpace(tempCM, [[-1, -3], [0, -2], [1, -1], [2, 0]], val)
                                }
                                break;
                        }
                        return judge;
                    },
                    spinMino: function(val) {
                        if (this.timeoutId) {
                            for (var i of this.timeoutId) {
                                clearInterval(i);
                            }
                            this.timeoutId = [];
                        }
                        out: if(this.intervalId) {
                            var judge = true;
                            var array = [[],[],[],[]];
                            var funcNum = [[], [], []];
                            var color = this.controlMino[1][2];
                            array[0] = this.controlMino[0][0].slice();
                            switch (this.controlMino[1][0]) {
                                case "I":
                                    array = [];
                                    array[0] = this.spin(0, 0, val, 4);
                                    array[1] = this.spin(0, 1, val, 3);
                                    array[2] = this.spin(1, 2, val, 3);
                                    array[3] = this.spin(0, 3, val, 5);
                                    break;
                                case "O":
                                    break out;
                                case "Z":
                                    array[1] = this.spin(2, 1, val, 1);
                                    array[2] = this.spin(1, 2, val, 1);
                                    array[3] = this.spin(0, 3, val, 2);
                                    break;
                                case "S":
                                    array[1] = this.spin(0, 1, val, 1);
                                    array[2] = this.spin(1, 2, val, 1);
                                    array[3] = this.spin(1, 3, val, 2);
                                    break;
                                case "L":
                                    array[1] = this.spin(0, 1, val, 1);
                                    array[2] = this.spin(2, 2, val, 1);
                                    array[3] = this.spin(1, 3, val, 2);
                                    break;
                                case "J":
                                    array[1] = this.spin(2, 1, val, 1);
                                    array[2] = this.spin(0, 2, val, 1);
                                    array[3] = this.spin(0, 3, val, 2);
                                    break;
                                case "T":
                                    array[1] = this.spin(0, 1, val, 1);
                                    array[2] = this.spin(1, 2, val, 1);
                                    array[3] = this.spin(2, 3, val, 1);
                                    break;
                            }
                            for (var [i, j] of array){
                                if (this.display[i][j] >= 19) {
                                    judge = false;
                                }
                            }
                            if (judge) {
                                this.deleteColor();
                                array.forEach(([i, j], index) => {
                                    this.display[i].splice(j, 1, color + 10);
                                    this.controlMino[0].splice(index, 1, [i, j]);
                                })
                                this.controlMino[1].splice(1, 1, this.controlMino[1][1] + val);
                            } else {
                                switch (this.controlMino[1][0]) {
                                    case "I":
                                        judge = this.Ispin(val);
                                        break;
                                    case "Z":
                                        judge = this.SZspin(val, 1);
                                        break;
                                    case "S":
                                        judge = this.SZspin(val, 0);
                                        break;
                                    case "L":
                                        judge = this.LJspin(val, 0);
                                        break;
                                    case "J":
                                        judge = this.LJspin(val, 1);
                                        break;
                                    case "T":
                                        judge = this.Tspin(val);
                                        break;
                                    default:
                                        console.log("error at spinMino");
                                        break;
                                }
                            }
                            if (!judge) {
                                for (var i = -1; i <= 2; i += 3) {
                                    judge = true;
                                    for (var j = 0; j < 4; j++) {
                                        array[j][1] += i;
                                    }
                                    for (var [k, l] of array){
                                        if (this.display[k][l] >= 19) {
                                            judge = false;
                                        }
                                    }
                                    if (judge) {
                                        this.deleteColor();
                                        array.forEach(([i, j], index) => {
                                            this.display[i].splice(j, 1, color + 10);
                                            this.controlMino[0].splice(index, 1, [i, j]);
                                        })
                                        this.controlMino[1].splice(1, 1, this.controlMino[1][1] + val);
                                    }
                                }
                            }
                        }
                        this.culcFellMino();
                        this.ground(1); 
                    },
                    keydown: function(e) {
                        switch (e.key) {
                            case "ArrowRight":
                                this.moveX(1);
                                break;
                            case "ArrowLeft":
                                this.moveX(-1);
                                break;
                            case "ArrowUp":
                                this.fallSkip();
                                break;
                            case "ArrowDown":
                                setTimeout(this.fallMino, 0);
                                break;
                            case "a":
                                this.spinMino(-1);
                                break;
                            case "s":
                                this.spinMino(1);
                                break;
                            case "c":
                                this.holdMino();
                                break;
                        }
                    },
                    clearLine: function() {
                        var topLayer = 23;
                        var bottomLayer = 0;
                        var array = [];
                        var index = [];
                        var score = 0;
                        for (var i = 23; i >= 0; i--) {
                            index.push(i);
                        }
                        for (var [i, j] of this.controlMino[0]) {
                            topLayer = i < topLayer ? i : topLayer;
                            bottomLayer = i > bottomLayer ? i : bottomLayer;
                        }
                        for (var i = topLayer; i <= bottomLayer; i++) {
                            var check = true;
                            for (var j = 1; j <= 10; j++) {
                                if (this.display[i][j] == 0) {
                                    check = false;
                                    break;
                                }
                            }
                            if (check) array.push(i);
                        }
                        var count = 0;
                        if (array.length > 0) {
                            if (this.controlMino[1][0] == "T") {
                                var aroundBlock = 0;
                                console.log(this.controlMino[0][0])
                                for (var i = -1; i <= 1; i += 2) {
                                    for (var j = -1; j <= 1; j += 2) {
                                        console.log(this.controlMino[0][0][0] + i, this.controlMino[0][0][1] + j)
                                        console.log(this.display[this.controlMino[0][0][0] + i][this.controlMino[0][0][1] + j])
                                        if (this.display[this.controlMino[0][0][0] + i][this.controlMino[0][0][1] + j] >= 19) aroundBlock++;
                                    }
                                }
                                console.log(aroundBlock);
                                if (aroundBlock >= 3) {
                                    if (this.BtoB) {
                                        score++;
                                    }
                                    if (array.length == 1 ) {
                                        if (this.display[this.controlMino[0][0][0] * 2 - this.controlMino[0][2][0]][this.controlMino[0][0][1] * 2 - this.controlMino[0][2][1]] == 0) {
                                            score++;
                                        }
                                    } else {
                                        score += array.length * 2;
                                    }
                                    this.BtoB = true;
                                } else {
                                    switch (array.length) {
                                        case 1:
                                            this.BtoB = false;
                                            break;
                                        case 2:
                                            score++;
                                            this.BtoB = false;
                                            break;
                                        case 3:
                                            score += 2;
                                            this.BtoB = false;
                                            break;
                                    }
                                    this.BtoB = false;
                                }
                            } else {
                                switch (array.length) {
                                    case 1:
                                        this.BtoB = false;
                                        break;
                                    case 2:
                                        score++;
                                        this.BtoB = false;
                                        break;
                                    case 3:
                                        score += 2;
                                        this.BtoB = false;
                                        break;
                                    case 4:
                                        if (this.BtoB) score++;
                                        score += 4;
                                        this.BtoB = true;
                                        break;
                                }
                            }
                            for (var i of array) {
                                index.splice(index.indexOf(i), 1);
                            }
                            index.forEach((i, idx) => {
                                this.display.splice(23 - idx, 1, this.display[i].slice())
                                count++;
                            })
                            for (var i = 0; i < (4 < (24 - count) ? 4 : 24 - count); i++) {
                                this.display.splice(23 - count - i, 1, [19,0,0,0,0,0,0,0,0,0,0,19]);
                            }
                            score += this.culcRenPower(this.ren);
                            this.ren++;
                        } else {
                            this.ren = 0;
                        }
                        this.totalScore += score;
                        
                        this.nextTurn();
                        //array.length = 消したライン数
                    },
                    moveToSpace: function(tempCM, moveArray, val) {
                        var judge = this.display[tempCM[0][0] + moveArray[0][0]][tempCM[0][1] + moveArray[0][1]] < 19 && this.display[tempCM[1][0] + moveArray[1][0]][tempCM[1][1] + moveArray[1][1]] < 19 && this.display[tempCM[2][0] + moveArray[2][0]][tempCM[2][1] + moveArray[2][1]] < 19 && this.display[tempCM[3][0] + moveArray[3][0]][tempCM[3][1] + moveArray[3][1]] < 19;
                        if (judge){
                            this.deleteColor();
                            this.controlMino[0].splice(0, 1, [tempCM[0][0] + moveArray[0][0], tempCM[0][1] + moveArray[0][1]]);
                            this.controlMino[0].splice(1, 1, [tempCM[1][0] + moveArray[1][0], tempCM[1][1] + moveArray[1][1]]);
                            this.controlMino[0].splice(2, 1, [tempCM[2][0] + moveArray[2][0], tempCM[2][1] + moveArray[2][1]]);
                            this.controlMino[0].splice(3, 1, [tempCM[3][0] + moveArray[3][0], tempCM[3][1] + moveArray[3][1]]);
                            this.paintColor();
                            this.controlMino[1].splice(1, 1, this.controlMino[1][1] + val);
                        }
                        return judge;
                    },
                    paintColor: function() {
                        var color = this.controlMino[1][2];
                        for (var [i, j] of this.controlMino[0]) {
                            this.display[i].splice(j, 1, color + 10);
                        }
                    },
                    deleteColor: function() {
                        for (var [i, j] of this.controlMino[0]) {
                            this.display[i].splice(j, 1, 0);
                        }
                    },
                    ground: function(val) {
                        if (this.intervalId) {
                            var judge = false;
                            for (var [i, j] of this.controlMino[0]){
                                if (this.display[i + 1][j] >= 19) {
                                    judge = true;
                                }
                            }
                            if (judge) {
                                this.moveCount += val;
                                if (this.moveCount >= 15) {
                                    this.timeout();
                                } else {
                                    this.timeoutId.push(setTimeout(this.timeout, 500));
                                }
                            }
                        }
                    },
                    attack: function(val) {
                        for (var i = 0; i < val; i++) {
                            var pushLine = [19, 28, 28, 28, 28, 28, 28, 28, 28, 28, 28, 19];
                            pushLine[Math.floor(Math.random() * 9 + 1)] = 0;
                            this.display.splice(23, 0, pushLine);
                            this.display.splice(0, 1);
                        }
                    },
                    gameOver: function() {
                        clearInterval(this.SUintervalId);
                    }
                },
                watch: {
                },
                mounted: function() {
                    document.addEventListener('keydown', this.keydown)
                }
            })
        </script>
    </body>
</html>